name: Build IPA

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest  # ä½¿ç”¨ GitHub æä¾›çš„ macOS è™šæ‹Ÿæœº

    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Xcode ç‰ˆæœ¬
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: æ˜¾ç¤º Xcode ä¿¡æ¯
      run: |
        xcodebuild -version
        xcode-select -p

    - name: æ£€æŸ¥é¡¹ç›®ç»“æ„
      run: |
        ls -la
        ls -la QuickUnzip/ || true

    - name: åˆ›å»ºç¼ºå¤±çš„è§†å›¾æ–‡ä»¶å¹¶æ·»åŠ åˆ°é¡¹ç›®
      run: |
        # åˆ›å»º TextEditorMainView.swiftï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f "QuickUnzip/Views/TextEditorView.swift" ]; then
          cat > QuickUnzip/Views/TextEditorMainView.swift << 'EOF'
        import SwiftUI

        struct TextEditorMainView: View {
            var body: some View {
                NavigationStack {
                    Text("æ–‡æœ¬ç¼–è¾‘å™¨")
                        .navigationTitle("ç¼–è¾‘")
                }
            }
        }
        EOF
        fi

        # åˆ›å»º ShareSheet.swiftï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f "QuickUnzip/Views/Components/ShareSheet.swift" ]; then
          mkdir -p QuickUnzip/Views/Components
          cat > QuickUnzip/Views/Components/ShareSheet.swift << 'EOF'
        import SwiftUI
        import UIKit

        struct ShareSheet: UIViewControllerRepresentable {
            let items: [Any]

            func makeUIViewController(context: Context) -> UIActivityViewController {
                let controller = UIActivityViewController(activityItems: items, applicationActivities: nil)
                return controller
            }

            func updateUIViewController(_ uiViewController: UIActivityViewController, context: Context) {}
        }
        EOF
        fi

        # å®‰è£… xcodeproj Ruby gem æ¥æ“ä½œé¡¹ç›®æ–‡ä»¶
        gem install xcodeproj

        # åˆ›å»º Ruby è„šæœ¬æ¥æ·»åŠ æ–‡ä»¶åˆ° Xcode é¡¹ç›®
        cat > add_files.rb << 'RUBY'
        require 'xcodeproj'

        project_path = 'QuickUnzip.xcodeproj'
        project = Xcodeproj::Project.open(project_path)

        # è·å–ä¸» target
        target = project.targets.first

        # è¦æ·»åŠ çš„æ–‡ä»¶åˆ—è¡¨
        files_to_add = [
          'QuickUnzip/Services/EncodingFixer.swift',
          'QuickUnzip/Services/ArchiveCleaner.swift',
          'QuickUnzip/Services/CompressionAnalyzer.swift',
          'QuickUnzip/Services/QRCodeGenerator.swift',
          'QuickUnzip/Views/ToolsView.swift',
          'QuickUnzip/Views/Tools/EncodingFixerView.swift',
          'QuickUnzip/Views/Tools/CleanerView.swift',
          'QuickUnzip/Views/Tools/AnalyzerView.swift',
          'QuickUnzip/Views/Tools/QRCodeView.swift',
          'QuickUnzip/Views/TextEditorMainView.swift',
          'QuickUnzip/Views/Components/ShareSheet.swift'
        ]

        files_to_add.each do |file_path|
          next unless File.exist?(file_path)

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²ç»åœ¨é¡¹ç›®ä¸­
          existing = project.files.find { |f| f.path == file_path }
          next if existing

          # æ·»åŠ æ–‡ä»¶åˆ°é¡¹ç›®
          file_ref = project.new_file(file_path)

          # æ·»åŠ åˆ°ç¼–è¯‘é˜¶æ®µ
          target.add_file_references([file_ref])

          puts "Added: #{file_path}"
        end

        project.save
        puts "Project updated successfully!"
        RUBY

        # è¿è¡Œè„šæœ¬
        ruby add_files.rb

    - name: å®‰è£…ä¾èµ–ï¼ˆå¦‚æœæœ‰ CocoaPodsï¼‰
      run: |
        if [ -f "Podfile" ]; then
          sudo gem install cocoapods
          pod install
        fi

    - name: æ¸…ç†æ„å»ºç¼“å­˜
      run: |
        xcodebuild clean -project QuickUnzip.xcodeproj -scheme QuickUnzip || true

    - name: æ„å»ºé¡¹ç›®ï¼ˆæ— ç­¾åï¼‰
      run: |
        xcodebuild build \
          -project QuickUnzip.xcodeproj \
          -scheme QuickUnzip \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

    - name: Archive é¡¹ç›®ï¼ˆæ— ç­¾åç‰ˆæœ¬ï¼‰
      run: |
        xcodebuild archive \
          -project QuickUnzip.xcodeproj \
          -scheme QuickUnzip \
          -archivePath $PWD/build/QuickUnzip.xcarchive \
          -configuration Release \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          -destination 'generic/platform=iOS'
      continue-on-error: true

    - name: åˆ›å»º Payload ç›®å½•
      run: |
        mkdir -p Payload

    - name: æŸ¥æ‰¾å¹¶å¤åˆ¶ .app æ–‡ä»¶
      run: |
        # ä» build ç›®å½•æŸ¥æ‰¾ .app
        APP_PATH=$(find $PWD/build -name "*.app" -type d | head -n 1)

        if [ -z "$APP_PATH" ]; then
          # å¦‚æœ build ç›®å½•æ²¡æœ‰ï¼Œå°è¯•ä»æ´¾ç”Ÿæ•°æ®æŸ¥æ‰¾
          DERIVED_DATA="$HOME/Library/Developer/Xcode/DerivedData"
          APP_PATH=$(find "$DERIVED_DATA" -name "QuickUnzip.app" -type d | head -n 1)
        fi

        if [ -n "$APP_PATH" ]; then
          echo "æ‰¾åˆ° .app æ–‡ä»¶: $APP_PATH"
          cp -R "$APP_PATH" Payload/
        else
          echo "é”™è¯¯: æœªæ‰¾åˆ° .app æ–‡ä»¶"
          exit 1
        fi

    - name: åˆ›å»ºæœªç­¾åçš„ IPA
      run: |
        zip -r QuickUnzip-unsigned.ipa Payload

    - name: æ˜¾ç¤º IPA ä¿¡æ¯
      run: |
        ls -lh QuickUnzip-unsigned.ipa
        unzip -l QuickUnzip-unsigned.ipa | head -n 20

    - name: ä¸Šä¼  IPA åˆ° Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: QuickUnzip-IPA
        path: QuickUnzip-unsigned.ipa
        retention-days: 30

    - name: è·å–æäº¤ä¿¡æ¯
      id: commit
      run: |
        echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        {
          echo "message<<EOF"
          git log -1 --pretty=%B
          echo "EOF"
        } >> $GITHUB_OUTPUT

    - name: åˆ›å»º Releaseï¼ˆä»…åœ¨æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶ï¼‰
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v3.0.0-build-${{ github.run_number }}
        name: QuickUnzip v3.0.0 Build ${{ github.run_number }}
        body: |
          ğŸ‰ QuickUnzip è‡ªåŠ¨æ„å»ºç‰ˆæœ¬

          **ç‰ˆæœ¬**: v3.0.0
          **æ„å»ºå·**: ${{ github.run_number }}
          **æäº¤**: ${{ steps.commit.outputs.sha_short }}
          **æäº¤ä¿¡æ¯**: ${{ steps.commit.outputs.message }}

          ## æ–°åŠŸèƒ½
          - ğŸ“ æ–‡ä»¶åä¹±ç ä¿®å¤å™¨
          - ğŸ§¹ å‹ç¼©åŒ…ç˜¦èº«å·¥å…·
          - ğŸ“Š å‹ç¼©ç‡åˆ†æå™¨
          - ğŸ“± äºŒç»´ç åˆ†äº«åŠŸèƒ½

          ## æ³¨æ„äº‹é¡¹
          âš ï¸ è¿™æ˜¯æœªç­¾åç‰ˆæœ¬ï¼Œéœ€è¦è‡ªç­¾ååæ‰èƒ½å®‰è£…åˆ°è®¾å¤‡

          ### å®‰è£…æ–¹æ³•
          1. ä¸‹è½½ `QuickUnzip-unsigned.ipa`
          2. ä½¿ç”¨ AltStore / Sideloadly / çˆ±æ€åŠ©æ‰‹ ç­‰å·¥å…·è‡ªç­¾å
          3. å®‰è£…åˆ°ä½ çš„ iOS è®¾å¤‡

        files: |
          QuickUnzip-unsigned.ipa
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
